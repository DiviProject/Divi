os: linux
dist: bionic
language: cpp

services:
  - docker

before_install:
  - sudo apt-get update -y
  - sudo apt install -y libsecret-1-0
  - wget https://github.com/docker/docker-credential-helpers/releases/download/v0.6.3/docker-credential-secretservice-v0.6.3-amd64.tar.gz
  - tar xvzf docker-credential-secretservice-v0.6.3-amd64.tar.gz
  - chmod +x docker-credential-secretservice
  - sudo mv docker-credential-secretservice /usr/local/bin
  - mkdir -p $HOME/.docker
  - touch $HOME/.docker/config.json
  - echo $'${DOCKER_CONFIG}' >> $HOME/.docker/config.json

script:
  # Compile from source
  - echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - pushd divi
  - docker build -t divi -f Dockerfile .
  - docker run --rm -v "`pwd`":/home/ubuntu/build/ -w /home/ubuntu/build/ -t divi /bin/bash -c "pushd src/GMock && autoreconf -fvi"
  - docker run --rm -v "`pwd`":/home/ubuntu/build/ -w /home/ubuntu/build/ -t divi /bin/bash -c "./autogen.sh && ./configure --without-gui NO_QT=1"
  - docker run --rm -v "`pwd`":/home/ubuntu/build/ -w /home/ubuntu/build/ -t divi /bin/bash -c "make check && pushd qa/rpc-tests/ && ./test_runner.py"
after_failure:
  - docker run --rm -v "`pwd`":/home/ubuntu/build/ -w /home/ubuntu/build/ -t divi /bin/bash -c "cat src/test-suite.log"